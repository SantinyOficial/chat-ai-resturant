import{a as D,b as B,c as N,d as ce,j}from"./chunk-OD5VWANA.js";import{a as le}from"./chunk-PDQIPCUJ.js";import{a as y,b as k}from"./chunk-CHDIVYYH.js";import{$a as re,Ib as R,J as X,Jb as V,Ka as _,L as W,Ma as m,Nb as se,O as Z,Oa as O,Ob as F,Pa as q,Qa as ee,Ra as o,Sa as n,T as U,Ta as te,Tb as de,Ua as ie,Va as ne,Wa as C,Xa as l,Ya as f,Z as z,_a as oe,a as G,ab as ae,b as Y,bb as r,cb as h,db as T,fa as u,fb as S,ga as g,gb as w,hb as E,jb as A,kb as P,m as J,ma as L,mb as M,q as K,va as s,wa as I,y as Q}from"./chunk-DHL7B2SE.js";function _e(a,p){if(a&1){let e=C();o(0,"div",28)(1,"span",29),r(2),n(),o(3,"span",30),r(4),P(5,"currency"),n(),o(6,"button",31),l("click",function(){let t=u(e).$implicit,d=f(2);return g(d.addToOrder(t))}),r(7,"A\xF1adir"),n()()}if(a&2){let e=p.$implicit;s(2),h(e.nombre),s(2),h(M(5,2,e.precio,"COP","symbol","1.0-0"))}}function Ce(a,p){if(a&1&&(o(0,"div",26)(1,"h4"),r(2,"Entradas"),n(),_(3,_e,8,7,"div",27),n()),a&2){let e=f();s(3),m("ngForOf",e.getItemsByCategory("entrada"))}}function xe(a,p){if(a&1){let e=C();o(0,"div",28)(1,"span",29),r(2),n(),o(3,"span",30),r(4),P(5,"currency"),n(),o(6,"button",31),l("click",function(){let t=u(e).$implicit,d=f(2);return g(d.addToOrder(t))}),r(7,"A\xF1adir"),n()()}if(a&2){let e=p.$implicit;s(2),h(e.nombre),s(2),h(M(5,2,e.precio,"COP","symbol","1.0-0"))}}function be(a,p){if(a&1&&(o(0,"div",26)(1,"h4"),r(2,"Platos Principales"),n(),_(3,xe,8,7,"div",27),n()),a&2){let e=f();s(3),m("ngForOf",e.getItemsByCategory("principal"))}}function ve(a,p){if(a&1){let e=C();o(0,"div",28)(1,"span",29),r(2),n(),o(3,"span",30),r(4),P(5,"currency"),n(),o(6,"button",31),l("click",function(){let t=u(e).$implicit,d=f(2);return g(d.addToOrder(t))}),r(7,"A\xF1adir"),n()()}if(a&2){let e=p.$implicit;s(2),h(e.nombre),s(2),h(M(5,2,e.precio,"COP","symbol","1.0-0"))}}function Pe(a,p){if(a&1&&(o(0,"div",26)(1,"h4"),r(2,"Postres"),n(),_(3,ve,8,7,"div",27),n()),a&2){let e=f();s(3),m("ngForOf",e.getItemsByCategory("postre"))}}function Me(a,p){if(a&1){let e=C();o(0,"div",28)(1,"span",29),r(2),n(),o(3,"span",30),r(4),P(5,"currency"),n(),o(6,"button",31),l("click",function(){let t=u(e).$implicit,d=f(2);return g(d.addToOrder(t))}),r(7,"A\xF1adir"),n()()}if(a&2){let e=p.$implicit;s(2),h(e.nombre),s(2),h(M(5,2,e.precio,"COP","symbol","1.0-0"))}}function ye(a,p){if(a&1&&(o(0,"div",26)(1,"h4"),r(2,"Bebidas"),n(),_(3,Me,8,7,"div",27),n()),a&2){let e=f();s(3),m("ngForOf",e.getItemsByCategory("bebida"))}}function Ie(a,p){a&1&&(ie(0),o(1,"p",32),r(2,"No has a\xF1adido items a tu pedido."),n(),ne())}function Oe(a,p){if(a&1){let e=C();o(0,"div",33)(1,"div",34)(2,"span",35)(3,"button",36),l("click",function(){let t=u(e).index,d=f();return g(d.decreaseQuantity(t))}),r(4,"-"),n(),r(5),o(6,"button",36),l("click",function(){let t=u(e).index,d=f();return g(d.increaseQuantity(t))}),r(7,"+"),n()(),o(8,"span",29),r(9),n(),o(10,"span",30),r(11),P(12,"currency"),n()(),o(13,"button",37),l("click",function(){let t=u(e).index,d=f();return g(d.removeItem(t))}),r(14,"\u2715"),n()()}if(a&2){let e=p.$implicit;s(5),T(" ",e.cantidad," "),s(4),h(e.nombre),s(2),h(M(12,3,e.precio*e.cantidad,"COP","symbol","1.0-0"))}}function Se(a,p){if(a&1&&(o(0,"div",38)(1,"div"),r(2),n()()),a&2){let e=f();s(),ee("status-message ",e.orderStatus.toLowerCase(),""),s(),h(e.orderStatusMessage)}}var ue=(()=>{class a{constructor(e,i){this.menuService=e,this.pedidoService=i,this.clienteId="",this.pedidoCreado=new L,this.cerrarModal=new L,this.selectedCategory="all",this.menuItems=[],this.orderStatus=null,this.orderStatusMessage="",this.currentPedido=this.initPedido()}ngOnInit(){this.loadMenuItems(),this.clienteId||(this.clienteId=localStorage.getItem("clienteId")||"cliente-"+Math.floor(Math.random()*1e3)),this.currentPedido.clienteId=this.clienteId}initPedido(){return{clienteNombre:"",clienteId:this.clienteId,mesa:0,items:[],total:0,estado:y.PENDIENTE,observaciones:""}}cerrar(){this.cerrarModal.emit()}loadMenuItems(){this.menuService.getAllMenus().subscribe({next:e=>{this.menuItems=e.flatMap(i=>i.items)},error:e=>{console.error("Error al cargar los men\xFAs",e)}})}filterCategory(e){this.selectedCategory=e}showCategory(e){return this.selectedCategory==="all"||this.selectedCategory===e}getItemsByCategory(e){return this.menuItems.filter(i=>i.categoria===e)}addToOrder(e){let i=this.currentPedido.items.findIndex(t=>t.nombre===e.nombre);if(i!==-1)this.currentPedido.items[i].cantidad+=1;else{let t={nombre:e.nombre,descripcion:e.descripcion,categoria:e.categoria,cantidad:1,precio:e.precio||0};this.currentPedido.items.push(t)}this.calculateTotal()}removeItem(e){this.currentPedido.items.splice(e,1),this.calculateTotal()}increaseQuantity(e){this.currentPedido.items[e].cantidad+=1,this.calculateTotal()}decreaseQuantity(e){this.currentPedido.items[e].cantidad>1?(this.currentPedido.items[e].cantidad-=1,this.calculateTotal()):this.removeItem(e)}calculateTotal(){this.currentPedido.total=this.currentPedido.items.reduce((e,i)=>e+i.precio*i.cantidad,0)}canConfirmOrder(){return this.currentPedido.items.length>0&&this.currentPedido.clienteNombre.trim()!==""&&this.currentPedido.mesa>0}confirmOrder(){this.orderStatus="pending",this.orderStatusMessage="Procesando pedido...",this.pedidoService.crearPedido(this.currentPedido).subscribe({next:e=>{this.orderStatus="success",this.orderStatusMessage="Pedido realizado con \xE9xito",this.pedidoCreado.emit(e),this.currentPedido=this.initPedido(),setTimeout(()=>{this.cerrar()},2e3)},error:e=>{this.orderStatus="error",this.orderStatusMessage="Error al realizar el pedido. Int\xE9ntelo de nuevo.",console.error("Error al crear pedido",e)}})}static{this.\u0275fac=function(i){return new(i||a)(I(le),I(k))}}static{this.\u0275cmp=z({type:a,selectors:[["app-realizar-pedido"]],inputs:{clienteId:"clienteId"},outputs:{pedidoCreado:"pedidoCreado",cerrarModal:"cerrarModal"},standalone:!0,features:[A],decls:52,vars:27,consts:[[1,"realizar-pedido-container"],[1,"pedido-header"],[1,"close-btn",3,"click"],[1,"pedido-content"],[1,"menu-section"],[1,"menu-filter"],[1,"filter-btn",3,"click"],[1,"menu-items-container"],["class","menu-category",4,"ngIf"],[1,"pedido-resumen"],[1,"cliente-info"],[1,"form-group"],["for","clienteNombre"],["type","text","id","clienteNombre","placeholder","Su nombre",3,"ngModelChange","ngModel"],["for","mesa"],["type","number","id","mesa","placeholder","N\xFAmero de mesa",3,"ngModelChange","ngModel"],[1,"pedido-items"],[4,"ngIf"],["class","order-item",4,"ngFor","ngForOf"],[1,"form-group","observaciones"],["for","observaciones"],["id","observaciones","placeholder","Especificaciones adicionales del pedido",3,"ngModelChange","ngModel"],[1,"pedido-total"],[1,"total-price"],[1,"confirm-button",3,"click","disabled"],["class","order-status",4,"ngIf"],[1,"menu-category"],["class","menu-item",4,"ngFor","ngForOf"],[1,"menu-item"],[1,"item-name"],[1,"item-price"],[1,"add-button",3,"click"],[1,"no-items"],[1,"order-item"],[1,"item-details"],[1,"item-quantity"],[1,"quantity-btn",3,"click"],[1,"remove-btn",3,"click"],[1,"order-status"]],template:function(i,t){i&1&&(o(0,"div",0)(1,"div",1)(2,"h3"),r(3,"Realizar Pedido"),n(),o(4,"button",2),l("click",function(){return t.cerrar()}),r(5,"\xD7"),n()(),o(6,"div",3)(7,"div",4)(8,"div",5)(9,"button",6),l("click",function(){return t.filterCategory("all")}),r(10,"Todos"),n(),o(11,"button",6),l("click",function(){return t.filterCategory("entrada")}),r(12,"Entradas"),n(),o(13,"button",6),l("click",function(){return t.filterCategory("principal")}),r(14,"Platos Principales"),n(),o(15,"button",6),l("click",function(){return t.filterCategory("postre")}),r(16,"Postres"),n(),o(17,"button",6),l("click",function(){return t.filterCategory("bebida")}),r(18,"Bebidas"),n()(),o(19,"div",7),_(20,Ce,4,1,"div",8)(21,be,4,1,"div",8)(22,Pe,4,1,"div",8)(23,ye,4,1,"div",8),n()(),o(24,"div",9)(25,"h4"),r(26,"Tu Pedido"),n(),o(27,"div",10)(28,"div",11)(29,"label",12),r(30,"Nombre:"),n(),o(31,"input",13),E("ngModelChange",function(c){return w(t.currentPedido.clienteNombre,c)||(t.currentPedido.clienteNombre=c),c}),n()(),o(32,"div",11)(33,"label",14),r(34,"Mesa:"),n(),o(35,"input",15),E("ngModelChange",function(c){return w(t.currentPedido.mesa,c)||(t.currentPedido.mesa=c),c}),n()()(),o(36,"div",16),_(37,Ie,3,0,"ng-container",17)(38,Oe,15,8,"div",18),n(),o(39,"div",19)(40,"label",20),r(41,"Observaciones:"),n(),o(42,"textarea",21),E("ngModelChange",function(c){return w(t.currentPedido.observaciones,c)||(t.currentPedido.observaciones=c),c}),n()(),o(43,"div",22)(44,"span"),r(45,"Total:"),n(),o(46,"span",23),r(47),P(48,"currency"),n()(),o(49,"button",24),l("click",function(){return t.confirmOrder()}),r(50,"Confirmar Pedido"),n(),_(51,Se,3,4,"div",25),n()()()),i&2&&(s(9),O("active",t.selectedCategory==="all"),s(2),O("active",t.selectedCategory==="entrada"),s(2),O("active",t.selectedCategory==="principal"),s(2),O("active",t.selectedCategory==="postre"),s(2),O("active",t.selectedCategory==="bebida"),s(3),m("ngIf",t.showCategory("entrada")),s(),m("ngIf",t.showCategory("principal")),s(),m("ngIf",t.showCategory("postre")),s(),m("ngIf",t.showCategory("bebida")),s(8),S("ngModel",t.currentPedido.clienteNombre),s(4),S("ngModel",t.currentPedido.mesa),s(2),m("ngIf",t.currentPedido.items.length===0),s(),m("ngForOf",t.currentPedido.items),s(4),S("ngModel",t.currentPedido.observaciones),s(5),h(M(48,22,t.currentPedido.total,"COP","symbol","1.0-0")),s(2),m("disabled",!t.canConfirmOrder()),s(2),m("ngIf",t.orderStatus))},dependencies:[F,R,V,se,j,D,ce,B,N],styles:[".realizar-pedido-container[_ngcontent-%COMP%]{position:fixed;inset:0;background-color:#000000d9;z-index:1000;display:flex;flex-direction:column;padding:20px;overflow-y:auto}.pedido-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.pedido-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:#ffcc29;margin:0}.close-btn[_ngcontent-%COMP%]{background:none;border:none;color:#fff;font-size:24px;cursor:pointer}.pedido-content[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 300px;gap:20px;max-width:1000px;margin:0 auto;width:100%}.menu-section[_ngcontent-%COMP%]{display:flex;flex-direction:column}.menu-filter[_ngcontent-%COMP%]{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}.filter-btn[_ngcontent-%COMP%]{padding:6px 12px;background:#333;color:#fff;border:none;border-radius:4px;cursor:pointer;transition:all .3s ease}.filter-btn.active[_ngcontent-%COMP%], .filter-btn[_ngcontent-%COMP%]:hover{background:#ffcc29;color:#181818}.menu-items-container[_ngcontent-%COMP%]{background:#222;border-radius:8px;padding:20px;box-shadow:0 4px 12px #00000026;border:2px solid #ffcc29;overflow-y:auto;max-height:500px}.menu-category[_ngcontent-%COMP%]{margin-bottom:25px}.menu-category[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{color:#ffcc29;margin-top:0}.menu-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#303030;margin-bottom:10px;border-radius:8px}.item-name[_ngcontent-%COMP%]{flex:1;color:#fff}.item-price[_ngcontent-%COMP%]{color:#ffcc29;font-weight:700;margin:0 15px}.add-button[_ngcontent-%COMP%]{padding:6px 12px;background:#ffcc29;color:#181818;border:none;border-radius:4px;cursor:pointer;transition:all .3s ease}.add-button[_ngcontent-%COMP%]:hover{background:#ffdd54;box-shadow:0 0 8px #ffcc29}.pedido-resumen[_ngcontent-%COMP%]{background:#222;border-radius:8px;padding:20px;box-shadow:0 4px 12px #00000026;border:2px solid #ffcc29;height:fit-content}.pedido-resumen[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{color:#ffcc29;margin-top:0}.cliente-info[_ngcontent-%COMP%]{margin-bottom:15px}.form-group[_ngcontent-%COMP%]{margin-bottom:10px}.form-group[_ngcontent-%COMP%]   label[_ngcontent-%COMP%]{display:block;margin-bottom:5px;color:#fff}.form-group[_ngcontent-%COMP%]   input[_ngcontent-%COMP%], .form-group[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{width:100%;padding:8px;background:#333;border:1px solid #444;color:#fff;border-radius:4px}.observaciones[_ngcontent-%COMP%]   textarea[_ngcontent-%COMP%]{min-height:60px;resize:vertical}.pedido-items[_ngcontent-%COMP%]{min-height:100px;margin-bottom:20px;max-height:250px;overflow-y:auto}.no-items[_ngcontent-%COMP%]{text-align:center;color:#888;margin-top:30px}.order-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#303030;margin-bottom:8px;border-radius:4px}.item-details[_ngcontent-%COMP%]{display:flex;align-items:center;flex:1}.item-quantity[_ngcontent-%COMP%]{display:flex;align-items:center;margin-right:10px;min-width:70px}.quantity-btn[_ngcontent-%COMP%]{width:24px;height:24px;background:#444;color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:700}.quantity-btn[_ngcontent-%COMP%]:hover{background:#555}.remove-btn[_ngcontent-%COMP%]{background:none;border:none;color:#ff5252;cursor:pointer;font-size:16px}.remove-btn[_ngcontent-%COMP%]:hover{color:red}.pedido-total[_ngcontent-%COMP%]{display:flex;justify-content:space-between;padding:15px 0;border-top:1px solid #333;margin-bottom:20px;color:#fff}.total-price[_ngcontent-%COMP%]{color:#ffcc29;font-weight:700;font-size:1.2rem}.confirm-button[_ngcontent-%COMP%]{width:100%;padding:12px;background:#ffcc29;color:#181818;border:none;border-radius:8px;font-weight:700;cursor:pointer;transition:all .3s ease}.confirm-button[_ngcontent-%COMP%]:hover:not(:disabled){background:#ffdd54;box-shadow:0 0 8px #ffcc29}.confirm-button[_ngcontent-%COMP%]:disabled{background:#444;color:#777;cursor:not-allowed}.order-status[_ngcontent-%COMP%]{margin-top:15px}.status-message[_ngcontent-%COMP%]{text-align:center;padding:10px;border-radius:4px;font-weight:700}.status-message.success[_ngcontent-%COMP%]{background:#4caf5033;color:#4caf50}.status-message.error[_ngcontent-%COMP%]{background:#f4433633;color:#f44336}.status-message.pending[_ngcontent-%COMP%]{background:#ffc10733;color:#ffc107}@media (max-width: 768px){.pedido-content[_ngcontent-%COMP%]{grid-template-columns:1fr}}"]})}}return a})();var $={production:!0,apiUrl:"https://banquetes-peter-api.herokuapp.com"};var ge=(()=>{class a{constructor(e,i){this.http=e,this.pedidoService=i,this.apiUrl=`${$.apiUrl}/api/assistant`,this.clienteId=localStorage.getItem("clienteId")||"cliente-"+Math.floor(Math.random()*1e3),this.conversationTimeouts=new Map,localStorage.getItem("clienteId")||localStorage.setItem("clienteId",this.clienteId)}sendMessage(e){return this.enrichRequestWithPedidoInfo(e).pipe(W(i=>{i.conversationId&&this.refreshConversationTimeout(i.conversationId)}),X(i=>this.http.post(`${this.apiUrl}/chat`,i)),W(i=>{i&&i.isNewConversation&&i.conversationId&&this.refreshConversationTimeout(i.conversationId)}),Q(i=>(console.error("Error al enviar mensaje al asistente",i),this.http.post(`${this.apiUrl}/chat`,e))))}enrichRequestWithPedidoInfo(e){let i=e.userId||this.clienteId;return this.pedidoService.getPedidosByCliente(i).pipe(K(t=>{let d=t&&t.length>0,c={hasPedidos:d,pedidoCount:t.length};if(d){let x=t.filter(v=>v.estado!==y.ENTREGADO&&v.estado!==y.CANCELADO);c.pedidosActivos=x.length,c.pedidosEstados=x.map(v=>`Pedido #${v.id?.substring(0,8)||"Nuevo"}: ${v.estado}`).join(", ");let b=this.getLastActivePedido(t);if(b){c.lastPedidoId=b.id,c.lastPedidoStatus=b.estado;let v=b.items.map(H=>`${H.cantidad}x ${H.nombre}`).join(", ");e.pedidoInfo=Y(G({},c),{pedidoItems:v,mesa:b.mesa.toString(),total:b.total.toString(),fechaCreacion:b.fechaCreacion||"desconocida"})}else e.pedidoInfo=c}else e.pedidoInfo=c;return e.userId||(e.userId=i),e}),Q(t=>(console.error("Error al obtener informaci\xF3n de pedidos",t),J(e))))}getLastActivePedido(e){let i=[...e].sort((t,d)=>{let c=t.fechaCreacion?new Date(t.fechaCreacion):new Date;return(d.fechaCreacion?new Date(d.fechaCreacion):new Date).getTime()-c.getTime()});return i.find(t=>t.estado!==y.ENTREGADO&&t.estado!==y.CANCELADO)||(i.length>0?i[0]:null)}refreshConversationTimeout(e){this.conversationTimeouts.has(e)&&clearTimeout(this.conversationTimeouts.get(e));let i=setTimeout(()=>{console.log(`Conversaci\xF3n ${e} expirada despu\xE9s de 6 minutos de inactividad`),this.conversationTimeouts.delete(e)},36e4);this.conversationTimeouts.set(e,i)}sendMessageDirect(e,i){return this.http.post(i,e)}getAllConversations(){return this.http.get(`${this.apiUrl}/conversations`)}getUserConversations(e){return this.http.get(`${this.apiUrl}/conversations/user/${e}`)}getConversationMessages(e){return this.http.get(`${this.apiUrl}/conversations/${e}/messages`)}deleteConversation(e){return this.conversationTimeouts.has(e)&&(clearTimeout(this.conversationTimeouts.get(e)),this.conversationTimeouts.delete(e)),this.http.delete(`${this.apiUrl}/conversations/${e}`)}getHealth(){return this.http.get(`${this.apiUrl}/health`)}static{this.\u0275fac=function(i){return new(i||a)(U(de),U(k))}}static{this.\u0275prov=Z({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();var Ee=["scrollContainer"];function ke(a,p){if(a&1&&(o(0,"div")(1,"div",10)(2,"p"),r(3),n()(),o(4,"span",11),r(5),n()()),a&2){let e=p.$implicit;q("message "+e.sender),s(3),h(e.text),s(2),h(e.time)}}function Te(a,p){a&1&&(o(0,"div",21)(1,"div",10)(2,"div",22),te(3,"span")(4,"span")(5,"span"),n()()())}function ze(a,p){if(a&1&&(o(0,"div",23),r(1),n()),a&2){let e=f();s(),T(" ",e.error," ")}}function Ae(a,p){if(a&1){let e=C();o(0,"app-realizar-pedido",24),l("pedidoCreado",function(t){u(e);let d=f();return g(d.onPedidoCreado(t))})("cerrarModal",function(){u(e);let t=f();return g(t.cerrarRealizarPedido())}),n()}if(a&2){let e=f();m("clienteId",e.clienteId)}}var et=(()=>{class a{constructor(e,i){this.assistantService=e,this.pedidoService=i,this.messages=[],this.userMessage="",this.loading=!1,this.error="",this.currentConversationId=null,this.mostrarRealizarPedido=!1,this.clienteId=localStorage.getItem("clienteId")||"cliente-"+Math.floor(Math.random()*1e3),this.pedidosSubscription=null}ngOnInit(){localStorage.setItem("clienteId",this.clienteId),this.checkBackendConnection();let e=localStorage.getItem("currentConversationId");if(e){let i=localStorage.getItem("lastChatActivity");i&&Date.now()-parseInt(i)<36e4?(this.currentConversationId=e,this.loadPreviousMessages()):(localStorage.removeItem("currentConversationId"),localStorage.removeItem("lastChatActivity"))}this.pedidosInterval=setInterval(()=>{this.refreshPedidosContext()},3e4)}ngOnDestroy(){this.pedidosInterval&&clearInterval(this.pedidosInterval),this.pedidosSubscription&&this.pedidosSubscription.unsubscribe()}refreshPedidosContext(){this.currentConversationId&&(this.pedidosSubscription=this.pedidoService.getPedidosByCliente(this.clienteId).subscribe({next:e=>{if(e&&e.length>0&&e.filter(t=>t.estado!=="ENTREGADO"&&t.estado!=="CANCELADO").length>0){let t={message:"_actualizaci\xF3n_de_contexto_",conversationId:this.currentConversationId||void 0,userId:this.clienteId};this.assistantService.sendMessage(t).subscribe({next:()=>console.log("Contexto de pedidos actualizado silenciosamente"),error:d=>console.error("Error actualizando contexto de pedidos:",d)})}},error:e=>console.error("Error consultando pedidos para actualizaci\xF3n de contexto:",e)}))}loadPreviousMessages(){this.currentConversationId&&(this.loading=!0,this.assistantService.getConversationMessages(this.currentConversationId).subscribe({next:e=>{this.messages=e.map(i=>({sender:i.role==="user"?"user":"bot",text:i.content,time:this.formatTimeFromTimestamp(i.timestamp||"")})),this.loading=!1},error:e=>{console.error("Error al cargar mensajes anteriores:",e),this.loading=!1,this.currentConversationId=null,localStorage.removeItem("currentConversationId")}}))}formatTimeFromTimestamp(e){if(!e)return"Desconocido";try{let i=new Date(e);return i.getHours()+":"+(i.getMinutes()<10?"0":"")+i.getMinutes()}catch{return"Desconocido"}}checkBackendConnection(){this.loading=!0,this.assistantService.getHealth().subscribe({next:e=>{console.log("Backend conectado:",e),this.loading=!1},error:e=>{console.error("Error al conectar con el backend:",e),this.error="No se pudo conectar con el servidor. Por favor, verifica que el backend est\xE9 en ejecuci\xF3n.",this.loading=!1}})}ngAfterViewChecked(){this.scrollToBottom()}scrollToBottom(){try{this.scrollContainer.nativeElement.scrollTop=this.scrollContainer.nativeElement.scrollHeight}catch{}}formatTime(){let e=new Date;return e.getHours()+":"+(e.getMinutes()<10?"0":"")+e.getMinutes()}sendMessage(){if(!this.userMessage.trim()||this.loading)return;let e=this.userMessage.trim();this.userMessage="",this.error="",this.loading=!0,this.messages.push({sender:"user",text:e,time:this.formatTime()});let i={message:e,conversationId:this.currentConversationId||void 0,userId:this.clienteId};console.log("Enviando mensaje al backend:",i),this.assistantService.sendMessage(i).subscribe({next:t=>{console.log("Respuesta recibida:",t),this.currentConversationId=t.conversationId,localStorage.setItem("currentConversationId",t.conversationId),localStorage.setItem("lastChatActivity",Date.now().toString()),this.messages.push({sender:"bot",text:t.message.content,time:this.formatTime()}),this.loading=!1},error:t=>{console.error("Error al enviar mensaje:",t),this.tryDirectConnection(i)}})}tryDirectConnection(e){console.log("Intentando conexi\xF3n directa con el backend");let i=`${$.apiUrl}/api/assistant/chat`;this.assistantService.sendMessageDirect(e,i).subscribe({next:t=>{console.log("Conexi\xF3n directa exitosa:",t),this.currentConversationId=t.conversationId,localStorage.setItem("currentConversationId",t.conversationId),localStorage.setItem("lastChatActivity",Date.now().toString()),this.messages.push({sender:"bot",text:t.message.content,time:this.formatTime()}),this.loading=!1},error:t=>{console.error("Error tambi\xE9n en conexi\xF3n directa:",t),this.handleError(t)}})}handleError(e){let i="Lo siento, ha ocurrido un error al procesar tu solicitud. Por favor, intenta nuevamente.";e.status===0?(i="No se pudo conectar con el servidor. Verifica que el backend est\xE9 en ejecuci\xF3n.",this.error="Error de conexi\xF3n: No se pudo establecer comunicaci\xF3n con el servidor"):e.status===404?(i="El servicio de chat no est\xE1 disponible en este momento. Por favor, intenta m\xE1s tarde.",this.error="Error 404: Servicio no encontrado"):e.status===500?(i="El servidor encontr\xF3 un error interno. Por favor, intenta m\xE1s tarde.",this.error="Error 500: Error interno del servidor"):this.error=`Error ${e.status}: ${e.statusText||"Error desconocido"}`,this.messages.push({sender:"bot",text:i,time:this.formatTime()}),this.loading=!1}abrirRealizarPedido(){this.mostrarRealizarPedido=!0}cerrarRealizarPedido(){this.mostrarRealizarPedido=!1}onPedidoCreado(e){if(console.log("Pedido creado:",e),this.messages.push({sender:"bot",text:`\xA1Tu pedido ha sido creado exitosamente! Tu n\xFAmero de pedido es: ${e.id}.
             Puedes consultar el estado de tu pedido en cualquier momento pregunt\xE1ndome o
             visitando la secci\xF3n de Pedidos.`,time:this.formatTime()}),this.loading=!1,this.cerrarRealizarPedido(),localStorage.setItem("lastChatActivity",Date.now().toString()),this.currentConversationId){let i={message:"Mi pedido fue creado, \xBFpuedes actualizarme sobre su estado?",conversationId:this.currentConversationId,userId:this.clienteId};this.assistantService.sendMessage(i).subscribe({next:t=>{console.log("Contexto de conversaci\xF3n actualizado con nuevo pedido")},error:t=>{console.error("Error al actualizar contexto con el nuevo pedido:",t)}})}}sendQuickQuestion(e){this.userMessage=e,this.sendMessage()}static{this.\u0275fac=function(i){return new(i||a)(I(ge),I(k))}}static{this.\u0275cmp=z({type:a,selectors:[["app-chat-asistente"]],viewQuery:function(i,t){if(i&1&&oe(Ee,5),i&2){let d;re(d=ae())&&(t.scrollContainer=d.first)}},standalone:!0,features:[A],decls:48,vars:10,consts:[["scrollContainer",""],[1,"container"],[1,"material-icons"],[1,"chat-container"],[1,"chat-header"],[1,"agent-info"],[1,"material-icons","agent-avatar"],[1,"agent-name"],[1,"chat-messages"],[1,"message","bot"],[1,"message-bubble"],[1,"message-time"],[3,"class",4,"ngFor","ngForOf"],["class","message bot loading",4,"ngIf"],["class","error-message",4,"ngIf"],[1,"chat-actions"],[1,"action-button",3,"click"],[1,"chat-input"],["type","text","placeholder","Escribe tu mensaje aqu\xED...",3,"ngModelChange","keyup.enter","ngModel","disabled"],[3,"click","disabled"],[3,"clienteId","pedidoCreado","cerrarModal",4,"ngIf"],[1,"message","bot","loading"],[1,"typing-indicator"],[1,"error-message"],[3,"pedidoCreado","cerrarModal","clienteId"]],template:function(i,t){if(i&1){let d=C();o(0,"div",1)(1,"h2")(2,"i",2),r(3,"support_agent"),n(),r(4," Chat Asistente"),n(),o(5,"div",3)(6,"div",4)(7,"div",5)(8,"i",6),r(9,"restaurant"),n(),o(10,"span",7),r(11,"Asistente de Banquetes Peter"),n()(),o(12,"span"),r(13),n()(),o(14,"div",8,0)(16,"div",9)(17,"div",10)(18,"p"),r(19,"Bienvenido al asistente de Banquetes Peter. \xBFEn qu\xE9 puedo ayudarte hoy?"),n()(),o(20,"span",11),r(21,"Ahora"),n()(),_(22,ke,6,4,"div",12)(23,Te,6,0,"div",13)(24,ze,2,1,"div",14),n(),o(25,"div",15)(26,"button",16),l("click",function(){return u(d),g(t.abrirRealizarPedido())}),o(27,"i",2),r(28,"restaurant_menu"),n(),r(29," Realizar Pedido "),n(),o(30,"button",16),l("click",function(){return u(d),g(t.sendQuickQuestion("\xBFCu\xE1l es el men\xFA del d\xEDa?"))}),o(31,"i",2),r(32,"menu_book"),n(),r(33," Ver Men\xFA "),n(),o(34,"button",16),l("click",function(){return u(d),g(t.sendQuickQuestion("\xBFCu\xE1l es el estado de mi pedido?"))}),o(35,"i",2),r(36,"local_shipping"),n(),r(37," Estado de Pedido "),n(),o(38,"button",16),l("click",function(){return u(d),g(t.sendQuickQuestion("\xBFCu\xE1les son los horarios del restaurante?"))}),o(39,"i",2),r(40,"access_time"),n(),r(41," Horarios "),n()(),o(42,"div",17)(43,"input",18),E("ngModelChange",function(x){return u(d),w(t.userMessage,x)||(t.userMessage=x),g(x)}),l("keyup.enter",function(){return u(d),g(t.sendMessage())}),n(),o(44,"button",19),l("click",function(){return u(d),g(t.sendMessage())}),o(45,"i",2),r(46,"send"),n()()()()(),_(47,Ae,1,1,"app-realizar-pedido",20)}i&2&&(s(12),q("status "+(t.error?"offline":"online")),s(),T(" ",t.error?"Sin conexi\xF3n":"En l\xEDnea"," "),s(9),m("ngForOf",t.messages),s(),m("ngIf",t.loading),s(),m("ngIf",t.error),s(19),S("ngModel",t.userMessage),m("disabled",t.loading),s(),m("disabled",t.loading||!t.userMessage.trim()),s(3),m("ngIf",t.mostrarRealizarPedido))},dependencies:[F,R,V,j,D,B,N,ue],styles:['.container[_ngcontent-%COMP%]{padding:0;max-width:850px;margin:0 auto}h2[_ngcontent-%COMP%]{color:var(--primary-color);margin-bottom:25px;font-size:1.8rem;display:flex;align-items:center;gap:10px}h2[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:2rem}.chat-container[_ngcontent-%COMP%]{background:var(--background-medium);border-radius:16px;box-shadow:0 8px 25px #0003;border:2px solid var(--primary-color);overflow:hidden;display:flex;flex-direction:column;height:calc(80vh - 120px)}.chat-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:15px 20px;background:#0003;border-bottom:1px solid rgba(255,204,41,.3)}.agent-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px}.agent-avatar[_ngcontent-%COMP%]{background:var(--primary-color);color:var(--background-dark);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;padding:5px}.agent-name[_ngcontent-%COMP%]{font-weight:600;font-size:1.1rem}.status[_ngcontent-%COMP%]{font-size:.9rem;display:flex;align-items:center;gap:5px}.status.online[_ngcontent-%COMP%]:before{content:"";display:inline-block;width:8px;height:8px;background:#4caf50;border-radius:50%}.status.offline[_ngcontent-%COMP%]:before{content:"";display:inline-block;width:8px;height:8px;background:#f44336;border-radius:50%}.chat-messages[_ngcontent-%COMP%]{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;gap:15px}.message[_ngcontent-%COMP%]{display:flex;flex-direction:column;max-width:80%}.message.user[_ngcontent-%COMP%]{align-self:flex-end}.message.bot[_ngcontent-%COMP%]{align-self:flex-start}.message-bubble[_ngcontent-%COMP%]{padding:12px 16px;border-radius:18px;position:relative;word-break:break-word}.message.user[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background:var(--primary-color);color:var(--background-dark);border-bottom-right-radius:4px}.message.bot[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background:#333;color:#fff;border-bottom-left-radius:4px}.message-time[_ngcontent-%COMP%]{font-size:.75rem;margin-top:5px;opacity:.6;align-self:flex-end}.message.bot[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{align-self:flex-start}.chat-input[_ngcontent-%COMP%]{display:flex;gap:10px;padding:15px 20px;background:#0003;border-top:1px solid rgba(255,204,41,.3)}input[_ngcontent-%COMP%]{flex:1;padding:14px 16px;border-radius:25px;border:1px solid rgba(255,204,41,.3);background:#ffffff0d;color:#fff;font-size:1rem;font-family:Quicksand,sans-serif}input[_ngcontent-%COMP%]:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 5px var(--primary-color)}button[_ngcontent-%COMP%]{width:50px;height:50px;background:var(--primary-color);color:var(--background-dark);border:none;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s ease}button[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{font-size:1.3rem}button[_ngcontent-%COMP%]:hover{transform:scale(1.05);box-shadow:0 0 8px var(--primary-color)}button[_ngcontent-%COMP%]:disabled{background:#555;cursor:not-allowed;opacity:.7}button[_ngcontent-%COMP%]:disabled:hover{transform:none;box-shadow:none}.error-message[_ngcontent-%COMP%]{color:#ff5252;text-align:center;margin:10px 0;font-size:.9rem}.typing-indicator[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:5px;height:20px}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{width:8px;height:8px;background:#fff;border-radius:50%;display:inline-block;animation:_ngcontent-%COMP%_bounce 1s infinite ease-in-out}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(1){animation-delay:0s}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(2){animation-delay:.2s}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(3){animation-delay:.4s}@keyframes _ngcontent-%COMP%_bounce{0%,60%,to{transform:translateY(0)}30%{transform:translateY(-6px)}}.chat-actions[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:10px;padding:15px 20px;border-top:1px solid rgba(255,204,41,.3);background:#0003}.action-button[_ngcontent-%COMP%]{flex:1;min-width:calc(50% - 10px);padding:10px;background:#ffffff0d;color:#fff;border:1px solid rgba(255,204,41,.3);border-radius:8px;display:flex;align-items:center;justify-content:flex-start;gap:10px;cursor:pointer;transition:all .3s ease}.action-button[_ngcontent-%COMP%]:hover{background:#ffcc2926;border-color:var(--primary-color);transform:translateY(-2px)}.action-button[_ngcontent-%COMP%]   .material-icons[_ngcontent-%COMP%]{color:var(--primary-color)}@media (max-width: 768px){.chat-container[_ngcontent-%COMP%]{height:calc(75vh - 80px)}h2[_ngcontent-%COMP%]{font-size:1.5rem}.chat-messages[_ngcontent-%COMP%]{padding:15px}.message[_ngcontent-%COMP%]{max-width:90%}}']})}}return a})();export{et as ChatAsistenteComponent};
